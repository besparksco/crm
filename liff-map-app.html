<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>門市地圖</title>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script>
        let map;
        let markers = [];
        
        // 從 URL 獲取 LIFF ID
        function getLiffIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('liffId');
        }

        // 獲取門市資料
        async function fetchStores() {
            try {
                const response = await fetch('https://api.besparks.co/api:G90hiIoE/companyStore/list');
                const data = await response.json();
                
                // 轉換 API 資料格式以符合地圖使用需求
                return data.map(store => ({
                    position: { 
                        lat: parseFloat(store.latitude), 
                        lng: parseFloat(store.longitude)
                    },
                    title: store.store_name,
                    content: `
                        <h3>${store.store_name}</h3>
                        <p>${store.address}</p>
                        ${store.link ? `<p><a href="${store.link}" target="_blank">更多資訊</a></p>` : ''}
                    `,
                    id: store.id
                }));
            } catch (error) {
                console.error('獲取門市資料失敗:', error);
                return [];
            }
        }

        // 初始化 LIFF
        async function initializeLiff() {
            try {
                const liffId = getLiffIdFromUrl();
                if (!liffId) {
                    throw new Error('未提供 LIFF ID');
                }
                
                await liff.init({ liffId: liffId });
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            } catch (err) {
                console.error('LIFF 初始化失敗', err);
            }
        }

        // 初始化 Google Maps
        async function initMap() {
            // 獲取門市資料
            const stores = await fetchStores();
            
            if (stores.length === 0) {
                console.error('沒有門市資料');
                return;
            }

            // 設定地圖中心點（以第一個門市為中心）
            const center = stores[0].position;
            
            // 建立地圖
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: center,
                disableDefaultUI: true,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            // 新增所有門市標記
            stores.forEach(store => {
                const marker = new google.maps.Marker({
                    position: store.position,
                    map: map,
                    title: store.title
                });

                // 新增 Info Window
                const infowindow = new google.maps.InfoWindow({
                    content: store.content
                });

                // 點擊標記時開啟 Info Window
                marker.addListener('click', () => {
                    // 關閉其他已開啟的 Info Windows
                    markers.forEach(m => m.infowindow?.close());
                    infowindow.open(map, marker);
                });

                marker.infowindow = infowindow;
                markers.push(marker);
            });

            // 調整地圖範圍以顯示所有標記
            const bounds = new google.maps.LatLngBounds();
            markers.forEach(marker => bounds.extend(marker.getPosition()));
            map.fitBounds(bounds);
        }

        // 當網頁載入完成時初始化
        window.onload = async () => {
            await initializeLiff();
        };
    </script>

    <!-- 請替換 YOUR_GOOGLE_MAPS_API_KEY 為您的 API Key -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKwJoeEVQBmNT8_EoiSueRCz5TZuVJS6k&callback=initMap">
    </script>
</body>
</html>
